# Полное объяснение работы программы SmartHome (3 лабораторная работа по ООП)

## 1. Общая архитектура проекта

SmartHome - это консольное приложение на C#, демонстрирующее принципы объектно-ориентированного программирования через реализацию системы "Умный дом". Проект иллюстрирует работу с классами, наследованием, инкапсуляцией, полиморфизмом, событиями и паттернами проектирования.

### Структура проекта:
```
3лабаООП/
├── Lab3.md                        - Документация
├── SmartHome/                     - Основной проект
│   ├── Program.cs                 - Главная точка входа
│   ├── Controllers/               - Контроллеры
│   │   ├── ControllerBase.cs      - Базовый контроллер
│   │   └── HomeController.cs      - Главный контроллер дома
│   ├── Devices/                   - Устройства
│   │   ├── Device.cs              - Базовый класс устройства
│   │   ├── Heater.cs              - Обогреватель
│   │   ├── Light.cs               - Свет
│   │   └── Thermostat.cs          - Термостат
│   ├── Events/                    - Система событий
│   │   ├── EventBus.cs            - Шина событий
│   │   └── IEventListener.cs      - Интерфейс слушателя событий
│   ├── Rooms/                     - Комнаты
│   │   └── Room.cs                - Класс комнаты
│   ├── Scenes/                    - Сцены
│   │   ├── DayScene.cs            - Дневная сцена
│   │   ├── EveningScene.cs        - Вечерняя сцена
│   │   ├── MorningScene.cs        - Утренняя сцена
│   │   ├── NightScene.cs          - Ночная сцена
│   │   └── SceneBase.cs           - Базовый класс сцены
│   └── [Другие файлы]             - Конфигурация, скомпилированные файлы
```

## 2. Главный файл программы (Program.cs)

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using SmartHome.Devices;
using SmartHome.Rooms;
using SmartHome.Controllers;
using SmartHome.Scenes;
using SmartHome.Events;

namespace SmartHome
{
    class Program
    {
        private static List<Room> _rooms = new();
        private static HomeController _homeController = null!;
        private static List<SceneBase> _scenes = new();

        static void Main(string[] args)
        {
            InitializeSystem();
            DisplayMainMenu();
        }

        static void InitializeSystem()
        {
            // Создание комнат
            var livingRoom = new Room("Гостиная");
            var bedroom = new Room("Спальня");
            var kitchen = new Room("Кухня");

            // Добавление устройств в гостиную
            livingRoom.AddDevice(new Light("Основной свет"));
            livingRoom.AddDevice(new Thermostat("Термостат"));
            livingRoom.AddDevice(new Heater("Обогреватель", 22));

            // Добавление устройств в спальню
            bedroom.AddDevice(new Light("Прикроватный свет"));
            bedroom.AddDevice(new Thermostat("Термостат"));
            bedroom.AddDevice(new Heater("Обогреватель", 22));

            // Добавление устройств на кухню
            kitchen.AddDevice(new Light("Кухонный свет"));
            kitchen.AddDevice(new Thermostat("Термостат"));
            kitchen.AddDevice(new Heater("Обогреватель", 22));

            _rooms.Add(livingRoom);
            _rooms.Add(bedroom);
            _rooms.Add(kitchen);

            // Инициализация контроллера
            _homeController = new HomeController(_rooms);

            // Инициализация сцен
            _scenes = new List<SceneBase>
            {
                new MorningScene(),
                new DayScene(),
                new EveningScene(),
                new NightScene()
            };
        }

        static void DisplayMainMenu()
        {
            while (true)
            {
                Console.Clear();
                Console.WriteLine("=== УМНЫЙ ДОМ ===");
                Console.WriteLine("1. Показать все состояния");
                Console.WriteLine("2. Управление комнатой");
                Console.WriteLine("3. Управление всеми девайсами");
                Console.WriteLine("4. Задать желаемые параметры дома");
                Console.WriteLine("5. Задать текущие параметры");
                Console.WriteLine("6. Сцены");
                Console.WriteLine("7. Включить автоматизацию");
                Console.WriteLine("8. Имитировать движение");
                Console.WriteLine("9. Включить все устройства в комнате");
                Console.WriteLine("0. Выход");
                Console.Write("Выберите опцию: ");

                var input = Console.ReadLine();
                switch (input)
                {
                    case "1": ShowAllStatuses(); break;
                    case "2": ManageRoom(); break;
                    case "3": ManageAllDevices(); break;
                    case "4": SetGlobalDesiredSettings(); break;
                    case "5": SetCurrentParameters(); break;
                    case "6": ShowScenesMenu(); break;
                    case "7": RunAutomation(); break;
                    case "8": SimulateMotion(); break;
                    case "9": TurnAllOnInRoom(); break;
                    case "0": return;
                    default: ShowError("Неверный выбор"); break;
                }
            }
        }
    }
}
```

**Пояснение:**
- Программа реализует интерактивное консольное меню для управления системой "Умный дом"
- Инициализирует 3 комнаты (гостиная, спальня, кухня) с различными устройствами
- Предоставляет 9 основных функций управления домом
- Использует паттерн "бесконечный цикл" для интерактивного взаимодействия

## 3. Основные компоненты системы

### 3.1 Базовый класс устройства (Device.cs)

```csharp
public abstract class Device
{
    public string Name { get; }
    public bool IsOn { get; protected set; }

    protected Device(string name)
    {
        Name = name;
        IsOn = false;
    }

    public abstract void Update();
    public virtual void TurnOn() => IsOn = true;
    public virtual void TurnOff() => IsOn = false;
}
```

**Ключевые особенности:**
- Абстрактный базовый класс для всех устройств
- Содержит общие свойства: `Name` и `IsOn`
- Определяет абстрактный метод `Update()` для обновления состояния
- Реализует базовые методы `TurnOn()` и `TurnOff()`

### 3.2 Конкретные устройства

**Свет (Light.cs):**
```csharp
public class Light : Device
{
    public int Brightness { get; private set; }
    public int DesiredBrightness { get; set; }
    public bool DesiredIsOn { get; set; }

    public Light(string name) : base(name) { }

    public override void Update()
    {
        IsOn = DesiredIsOn;
        Brightness = DesiredIsOn ? DesiredBrightness : 0;
    }

    public void SetBrightness(int brightness)
    {
        DesiredBrightness = brightness;
        Update();
    }
}
```

**Обогреватель (Heater.cs):**
```csharp
public class Heater : Device
{
    public int CurrentTemperature { get; private set; }
    public int DesiredTemperature { get; set; }

    public Heater(string name, int initialTemp) : base(name)
    {
        CurrentTemperature = initialTemp;
        DesiredTemperature = initialTemp;
    }

    public override void Update()
    {
        if (IsOn)
        {
            CurrentTemperature = DesiredTemperature;
        }
    }
}
```

**Термостат (Thermostat.cs):**
```csharp
public class Thermostat : Device
{
    public int CurrentTemperature { get; set; }
    public int DesiredTemperature { get; set; }

    public Thermostat(string name) : base(name)
    {
        CurrentTemperature = 22;
        DesiredTemperature = 22;
    }

    public override void Update()
    {
        // Термостат всегда включен и обновляет текущую температуру
        IsOn = true;
    }
}
```

### 3.3 Класс комнаты (Room.cs)

```csharp
public class Room
{
    public string Name { get; }
    private List<Device> _devices = new();

    public Room(string name)
    {
        Name = name;
    }

    public void AddDevice(Device device)
    {
        _devices.Add(device);
    }

    public List<Device> GetDevices() => _devices;

    public void DisplayStatus()
    {
        Console.WriteLine($"\n--- {Name} ---");
        foreach (var device in _devices)
        {
            Console.WriteLine($"{device.Name}: {(device.IsOn ? "ВКЛ" : "ВЫКЛ")}");
            if (device is Light light)
                Console.WriteLine($"  Яркость: {light.Brightness}%");
            if (device is Heater heater)
                Console.WriteLine($"  Температура: {heater.CurrentTemperature}°C");
            if (device is Thermostat thermostat)
                Console.WriteLine($"  Текущая: {thermostat.CurrentTemperature}°C, Желаемая: {thermostat.DesiredTemperature}°C");
        }
    }

    public void TurnAllOn()
    {
        foreach (var device in _devices)
        {
            device.TurnOn();
            if (device is Light light)
                light.DesiredBrightness = 100;
            if (device is Heater heater)
                heater.DesiredTemperature = 22;
        }
    }
}
```

### 3.4 Базовый контроллер (ControllerBase.cs)

```csharp
public abstract class ControllerBase
{
    protected List<Room> Rooms { get; }

    protected ControllerBase(List<Room> rooms)
    {
        Rooms = rooms;
    }

    public abstract void Execute();
}
```

### 3.5 Главный контроллер дома (HomeController.cs)

```csharp
public class HomeController : ControllerBase
{
    public HomeController(List<Room> rooms) : base(rooms) { }

    public override void Execute()
    {
        foreach (var room in Rooms)
        {
            foreach (var device in room.GetDevices())
            {
                device.Update();
            }
        }
    }
}
```

### 3.6 Система событий (EventBus.cs)

```csharp
public class EventBus
{
    private static EventBus _instance;
    private Dictionary<string, List<Action<object>>> _eventHandlers = new();

    public static EventBus Instance => _instance ??= new EventBus();

    public void Subscribe(string eventName, Action<object> handler)
    {
        if (!_eventHandlers.ContainsKey(eventName))
            _eventHandlers[eventName] = new List<Action<object>>();

        _eventHandlers[eventName].Add(handler);
    }

    public void Publish(string eventName, object data)
    {
        if (_eventHandlers.ContainsKey(eventName))
        {
            foreach (var handler in _eventHandlers[eventName])
            {
                handler(data);
            }
        }
    }
}
```

### 3.7 Базовый класс сцены (SceneBase.cs)

```csharp
public abstract class SceneBase
{
    public abstract string Name { get; }

    public abstract void Execute(List<Room> rooms);
}
```

### 3.8 Конкретные сцены

**Утренняя сцена (MorningScene.cs):**
```csharp
public class MorningScene : SceneBase
{
    public override string Name => "Утро";

    public override void Execute(List<Room> rooms)
    {
        foreach (var room in rooms)
        {
            foreach (var device in room.GetDevices())
            {
                if (device is Light light)
                {
                    light.DesiredIsOn = true;
                    light.DesiredBrightness = 75;
                }
                if (device is Heater heater)
                {
                    heater.DesiredTemperature = 22;
                }
            }
        }
    }
}
```

**Дневная сцена (DayScene.cs):**
```csharp
public class DayScene : SceneBase
{
    public override string Name => "День";

    public override void Execute(List<Room> rooms)
    {
        foreach (var room in rooms)
        {
            foreach (var device in room.GetDevices())
            {
                if (device is Light light)
                {
                    light.DesiredIsOn = false;
                }
                if (device is Heater heater)
                {
                    heater.DesiredTemperature = 20;
                }
            }
        }
    }
}
```

## 4. Основные концепции ООП в проекте

### 4.1 Инкапсуляция

```csharp
// Пример инкапсуляции в классе Light
public class Light : Device
{
    // Приватное поле
    private int _brightness;

    // Публичное свойство с контролем доступа
    public int Brightness
    {
        get => _brightness;
        private set => _brightness = Math.Clamp(value, 0, 100);
    }

    // Публичный метод для безопасного изменения состояния
    public void SetBrightness(int brightness)
    {
        Brightness = brightness;
        Update();
    }
}
```

### 4.2 Наследование

```csharp
// Базовый класс
public abstract class Device
{
    public string Name { get; }
    public bool IsOn { get; protected set; }

    public abstract void Update();
}

// Наследуемый класс
public class Light : Device
{
    public int Brightness { get; private set; }

    public override void Update()
    {
        // Реализация специфичная для света
    }
}
```

### 4.3 Полиморфизм

```csharp
// Использование полиморфизма в главном контроллере
public override void Execute()
{
    foreach (var room in Rooms)
    {
        foreach (var device in room.GetDevices())
        {
            // Вызов виртуального метода Update() для каждого типа устройства
            device.Update();
        }
    }
}
```

### 4.4 Абстракция

```csharp
// Абстрактный базовый класс
public abstract class Device
{
    public abstract void Update();
}

// Абстрактный класс сцены
public abstract class SceneBase
{
    public abstract string Name { get; }
    public abstract void Execute(List<Room> rooms);
}
```

### 4.5 Композиция

```csharp
// Класс Room использует композицию для управления устройствами
public class Room
{
    private List<Device> _devices = new();

    public void AddDevice(Device device)
    {
        _devices.Add(device);
    }

    public void DisplayStatus()
    {
        foreach (var device in _devices)
        {
            // Работа с устройствами
        }
    }
}
```

## 5. Паттерны проектирования

### 5.1 Паттерн Наблюдатель (Observer)

```csharp
// Реализация через EventBus
public class EventBus
{
    private Dictionary<string, List<Action<object>>> _eventHandlers = new();

    public void Subscribe(string eventName, Action<object> handler)
    {
        _eventHandlers[eventName].Add(handler);
    }

    public void Publish(string eventName, object data)
    {
        foreach (var handler in _eventHandlers[eventName])
        {
            handler(data);
        }
    }
}

// Использование в программе
EventBus.Instance.Subscribe("MotionDetected", roomName =>
{
    Console.WriteLine($"Движение обнаружено в {roomName} - включаем свет");
    // Логика обработки события
});
```

### 5.2 Паттерн Стратегия (Strategy)

```csharp
// Различные сцены как стратегии управления домом
public abstract class SceneBase
{
    public abstract void Execute(List<Room> rooms);
}

// Конкретные стратегии
public class MorningScene : SceneBase { /* реализация */ }
public class DayScene : SceneBase { /* реализация */ }
public class EveningScene : SceneBase { /* реализация */ }
public class NightScene : SceneBase { /* реализация */ }

// Использование стратегии
var scene = new MorningScene();
scene.Execute(_rooms);
```

### 5.3 Паттерн Команды (Command)

```csharp
// Каждое устройство инкапсулирует команду в методе
public class Light : Device
{
    public void TurnOn() => IsOn = true;
    public void TurnOff() => IsOn = false;
    public void SetBrightness(int brightness) { /* логика */ }
}

// Использование команд
light.TurnOn();
light.SetBrightness(75);
```

## 6. Пример работы программы

При запуске программы пользователь видит следующее меню:

```
=== УМНЫЙ ДОМ ===
1. Показать все состояния
2. Управление комнатой
3. Управление всеми девайсами
4. Задать желаемые параметры дома
5. Задать текущие параметры
6. Сцены
7. Включить автоматизацию
8. Имитировать движение
9. Включить все устройства в комнате
0. Выход
Выберите опцию:
```

### 6.1 Показать все состояния

```
=== СОСТОЯНИЕ ВСЕХ УСТРОЙСТВ ===

--- Гостиная ---
Основной свет: ВЫКЛ
  Яркость: 0%
Термостат: ВКЛ
  Текущая: 22°C, Желаемая: 22°C
Обогреватель: ВЫКЛ
  Температура: 22°C

--- Спальня ---
Прикроватный свет: ВЫКЛ
  Яркость: 0%
Термостат: ВКЛ
  Текущая: 22°C, Желаемая: 22°C
Обогреватель: ВЫКЛ
  Температура: 22°C
```

### 6.2 Управление комнатой

```
=== УПРАВЛЕНИЕ КОМНАТОЙ ===

Выберите комнату:
1. Гостиная
2. Спальня
3. Кухня
Введите номер: 1

Управление комнатой: Гостиная
1. Управление светом
2. Управление температурой
Выберите опцию: 1

Управление светом в Гостиная
1. Включить свет
2. Выключить свет
3. Установить яркость
Выберите опцию: 1

✅ Свет включен
```

### 6.3 Сцены

```
=== СЦЕНЫ ===
1. Утро
2. День
3. Вечер
4. Ночь
Выберите сцену: 1

✅ Сцена 'Утро' применена
```

## 7. Технические детали реализации

### 7.1 Инициализация системы

```csharp
static void InitializeSystem()
{
    // Создание комнат
    var livingRoom = new Room("Гостиная");
    var bedroom = new Room("Спальня");
    var kitchen = new Room("Кухня");

    // Добавление устройств
    livingRoom.AddDevice(new Light("Основной свет"));
    livingRoom.AddDevice(new Thermostat("Термостат"));
    livingRoom.AddDevice(new Heater("Обогреватель", 22));

    // Добавление комнат в систему
    _rooms.Add(livingRoom);
    _rooms.Add(bedroom);
    _rooms.Add(kitchen);

    // Инициализация контроллера
    _homeController = new HomeController(_rooms);

    // Инициализация сцен
    _scenes = new List<SceneBase>
    {
        new MorningScene(),
        new DayScene(),
        new EveningScene(),
        new NightScene()
    };
}
```

### 7.2 Обработка пользовательского ввода

```csharp
static void DisplayMainMenu()
{
    while (true)
    {
        Console.Clear();
        // Отображение меню

        var input = Console.ReadLine();
        switch (input)
        {
            case "1": ShowAllStatuses(); break;
            case "2": ManageRoom(); break;
            // Другие случаи
            case "0": return;
            default: ShowError("Неверный выбор"); break;
        }
    }
}
```

### 7.3 Управление устройствами

```csharp
static void ManageRoomLight(Room room)
{
    var light = room.GetDevices().OfType<Light>().FirstOrDefault();
    if (light == null) return;

    Console.WriteLine($"\nУправление светом в {room.Name}");
    Console.WriteLine("1. Включить свет");
    Console.WriteLine("2. Выключить свет");
    Console.WriteLine("3. Установить яркость");

    var input = Console.ReadLine();
    switch (input)
    {
        case "1":
            light.DesiredIsOn = true;
            ShowSuccess("Свет включен");
            break;
        case "2":
            light.DesiredIsOn = false;
            ShowSuccess("Свет выключен");
            break;
        case "3":
            int brightness;
            do {
                Console.Write("Введите яркость (0-100): ");
            } while (!int.TryParse(Console.ReadLine(), out brightness) || brightness < 0 || brightness > 100);

            light.DesiredBrightness = brightness;
            ShowSuccess($"Яркость установлена на {brightness}%");
            break;
    }
}
```

## 8. Практические применения

Концепции, продемонстрированные в этом проекте, применяются в реальных сценариях:

1. **Системы умного дома**: Управление освещением, отоплением и другими устройствами
2. **Интернет вещей (IoT)**: Управление подключенными устройствами
3. **Автоматизация зданий**: Системы управления зданиями и офисами
4. **Робототехника**: Управление датчиками и исполнительными механизмами
5. **Игровые движки**: Управление игровыми объектами и сценами

## 9. Заключение

Этот проект демонстрирует ключевые концепции объектно-ориентированного программирования:

1. **Инкапсуляция**: Сокрытие внутренней реализации и предоставление контролируемого интерфейса
2. **Наследование**: Создание иерархии классов с общим поведением
3. **Полиморфизм**: Использование одного интерфейса для разных типов объектов
4. **Абстракция**: Создание абстрактных классов для определения интерфейсов
5. **Композиция**: Построение сложных объектов из более простых
6. **Паттерны проектирования**: Наблюдатель, Стратегия, Команда

Проект служит отличной основой для изучения ООП и может быть расширен для решения реальных задач в области управления умными устройствами и автоматизации.
